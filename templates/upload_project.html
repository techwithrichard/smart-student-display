{% extends "base.html" %}

{% block title %}Upload Project{% endblock %}

{% block content %}
<div class="container">
    <div class="form-container">
        <h1>Upload Project</h1>
        <form method="POST" action="{{ url_for('upload_project') }}" enctype="multipart/form-data">
            <div class="form-group">
                <label for="title">Project Title</label>
                <input type="text" id="title" name="title" required>
            </div>
            
            <div class="form-group">
                <label for="description">Description</label>
                <textarea id="description" name="description" rows="4"></textarea>
            </div>
            
            <div class="form-group">
                <label for="classroom_id">Classroom</label>
                <select id="classroom_id" name="classroom_id" required>
                    <option value="">Select a classroom</option>
                    {% for classroom in classrooms %}
                        <option value="{{ classroom.id }}">{{ classroom.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="project_type">Project Type</label>
                <select id="project_type" name="project_type" required onchange="toggleProjectInput()">
                    <option value="">Select type</option>
                    <option value="html">HTML Page</option>
                    <option value="scratch">Scratch Link</option>
                </select>
            </div>
            
            <div class="form-group" id="html-input" style="display: none;">
                <label>Upload Method</label>
                <div class="upload-method-selector">
                    <label class="upload-option">
                        <input type="radio" name="upload_type" value="single" checked onchange="toggleUploadMethod()">
                        <span>Single HTML File</span>
                    </label>
                    <label class="upload-option">
                        <input type="radio" name="upload_type" value="zip" onchange="toggleUploadMethod()">
                        <span>ZIP Archive (Whole Project)</span>
                    </label>
                    <label class="upload-option">
                        <input type="radio" name="upload_type" value="multiple" onchange="toggleUploadMethod()">
                        <span>Multiple Files</span>
                    </label>
                </div>
                
                <div id="single-upload" class="upload-section">
                    <label for="file">Upload HTML File</label>
                    <input type="file" id="file" name="file" accept=".html">
                    <small>Upload a single HTML file</small>
                </div>
                
                <div id="zip-upload" class="upload-section" style="display: none;">
                    <label for="zip_file">Upload ZIP File</label>
                    <input type="file" id="zip_file" name="zip_file" accept=".zip">
                    <small>Upload a ZIP file containing your entire project. The system will automatically find and use index.html (or the first HTML file) as the main entry point.</small>
                </div>
                
                <div id="multiple-upload" class="upload-section" style="display: none;">
                    <label for="files">Upload Multiple Files</label>
                    <input type="file" id="files" name="files[]" multiple accept=".html,.css,.js,.png,.jpg,.jpeg,.gif,.svg,.json,.txt,.ico">
                    <small>Select multiple files (HTML, CSS, JS, images, etc.). Original filenames will be preserved.</small>
                    <div id="file-list" class="file-list"></div>
                </div>
            </div>
            
            <div class="form-group" id="scratch-input" style="display: none;">
                <label for="scratch_link">Scratch Project Link</label>
                <input type="url" id="scratch_link" name="scratch_link" placeholder="https://scratch.mit.edu/projects/...">
            </div>
            
            <div class="form-group">
                <label for="screenshot">Project Screenshot (Optional)</label>
                <input type="file" id="screenshot" name="screenshot" accept="image/*">
                <small>Upload a screenshot of your project. This will be shown when code cannot be displayed.</small>
            </div>
            
            <button type="submit" class="btn btn-primary btn-block">Upload Project</button>
        </form>
    </div>
</div>

<script>
function toggleProjectInput() {
    const projectType = document.getElementById('project_type').value;
    const htmlInput = document.getElementById('html-input');
    const scratchInput = document.getElementById('scratch-input');
    
    if (projectType === 'html') {
        htmlInput.style.display = 'block';
        scratchInput.style.display = 'none';
        toggleUploadMethod();
    } else if (projectType === 'scratch') {
        htmlInput.style.display = 'none';
        scratchInput.style.display = 'block';
        document.getElementById('file').required = false;
        document.getElementById('scratch_link').required = true;
    } else {
        htmlInput.style.display = 'none';
        scratchInput.style.display = 'none';
        document.getElementById('file').required = false;
        document.getElementById('scratch_link').required = false;
    }
}

function toggleUploadMethod() {
    const uploadType = document.querySelector('input[name="upload_type"]:checked').value;
    const singleUpload = document.getElementById('single-upload');
    const zipUpload = document.getElementById('zip-upload');
    const multipleUpload = document.getElementById('multiple-upload');
    
    singleUpload.style.display = uploadType === 'single' ? 'block' : 'none';
    zipUpload.style.display = uploadType === 'zip' ? 'block' : 'none';
    multipleUpload.style.display = uploadType === 'multiple' ? 'block' : 'none';
    
    document.getElementById('file').required = uploadType === 'single';
    document.getElementById('zip_file').required = uploadType === 'zip';
    document.getElementById('files').required = uploadType === 'multiple';
}

document.getElementById('files')?.addEventListener('change', function(e) {
    const fileList = document.getElementById('file-list');
    fileList.innerHTML = '';
    
    if (this.files.length > 0) {
        const list = document.createElement('ul');
        list.className = 'selected-files';
        for (let i = 0; i < this.files.length; i++) {
            const li = document.createElement('li');
            li.textContent = this.files[i].name + ' (' + formatFileSize(this.files[i].size) + ')';
            list.appendChild(li);
        }
        fileList.appendChild(list);
    }
});

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}
</script>
{% endblock %}
